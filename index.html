<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAW - Visi√≥n Realizada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1E1E1E;
            --primary-color: #E60073; /* Magenta */
            --secondary-color: #00FF7F; /* Verde Menta */
            --accent-color-orange: #FFA500;
            --accent-color-purple: #9D4EDD;
            --text-color: #E0E0E0;
            --text-color-dark: #121212;
            --border-color: rgba(255, 255, 255, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif; background: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .container { display: grid; grid-template-columns: 280px 1fr 280px; grid-template-rows: auto 1fr; height: 100vh; gap: 15px; padding: 15px; }
        .header { grid-column: 1 / -1; text-align: center; margin-bottom: 10px; }
        .song-structure { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .structure-btn { padding: 8px 16px; background: #333; border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-color); cursor: pointer; transition: all 0.2s ease; position: relative; font-size: 14px; }
        .structure-btn:hover { background: #555; }
        .structure-btn.active { background: var(--primary-color); color: var(--text-color-dark); font-weight: bold; border-color: var(--primary-color); }
        .repeat-indicator { position: absolute; top: -8px; right: -8px; background: var(--secondary-color); color: var(--text-color-dark); border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .header-controls { display: flex; gap: 10px; justify-content: center; }
        .header-btn { padding: 8px 16px; background: #444; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); cursor: pointer; font-size: 14px; }
        .header-btn:hover { background: #666; }
        .sidebar { background: var(--surface-color); border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); display: flex; flex-direction: column;}
        .sidebar h3 { margin-bottom: 20px; font-size: 1.5rem; text-align: center; letter-spacing: 2px; }
        .item-list-container { overflow-y: auto; flex-grow: 1; }
        .bpm-group { margin-bottom: 20px; }
        .bpm-label { color: var(--secondary-color); font-weight: bold; margin-bottom: 10px; display: block; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .loop-item, .sample-item { display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px; margin-bottom: 8px; background: #2a2a2a; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); cursor: grab; transition: background-color 0.2s ease; }
        .loop-item:hover, .sample-item:hover { background: #3a3a3a; }
        .loop-item:active, .sample-item:active { cursor: grabbing; }
        .item-icon { font-size: 1.2rem; }
        .item-waveform { flex-grow: 1; height: 30px; background: linear-gradient(to right, transparent, rgba(0, 255, 127, 0.2), transparent); border-radius: 4px; }
        .main-workspace { grid-column: 2 / 3; grid-row: 2 / 3; background: var(--bg-color); border-radius: 12px; border: 1px solid var(--border-color); padding: 20px; overflow-x: auto; }
        .track-grid { display: grid; grid-auto-columns: 150px; grid-auto-flow: column; gap: 10px; width: max-content; }
        .track-lane { display: contents; } /* Allows direct grid placement of children */
        .track-label { background: #444; padding: 15px 10px; border-radius: 8px; text-align: center; font-weight: bold; display: flex; align-items: center; justify-content: center; height: 80px; }
        .track-label.drums { background: var(--primary-color); color: var(--text-color-dark); }
        .track-label.bass { background: var(--secondary-color); color: var(--text-color-dark); }
        .track-label.pads { background: var(--accent-color-orange); color: var(--text-color-dark); }
        .track-label.lead { background: var(--accent-color-purple); color: var(--text-color-dark); }
        .drop-zone { height: 80px; border: 2px dashed #444; border-radius: 8px; transition: all 0.2s ease; }
        .drop-zone.drag-over { border-color: var(--secondary-color); background: rgba(0, 255, 127, 0.1); }
        .drop-zone.filled { border-style: solid; border-color: var(--secondary-color); background: rgba(0, 255, 127, 0.2); padding: 5px; }
        .dropped-item { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 12px; position: relative; background: #2a2a2a; border-radius: 4px; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="song-structure" id="songStructure">
                <button class="structure-btn active" data-section="intro">intro<span class="repeat-indicator">1</span></button>
                <button class="structure-btn" data-section="verso">verso<span class="repeat-indicator">1</span></button>
                <button class="structure-btn" data-section="coro">coro<span class="repeat-indicator">2</span></button>
                <button class="structure-btn" data-section="puente">puente<span class="repeat-indicator">1</span></button>
                <button class="structure-btn" data-section="salida">salida/final<span class="repeat-indicator">1</span></button>
            </div>
            <div class="header-controls">
                <button class="header-btn" id="addSectionBtn">+ A√±adir Secci√≥n</button>
                <button class="header-btn" id="copySectionBtn">üìã Copiar Secci√≥n</button>
            </div>
        </div>

        <div class="sidebar sidebar-left">
            <h3>LOOPS</h3>
            <div class="item-list-container" id="loop-list">
                <!-- Los loops se generar√°n aqu√≠ con JavaScript -->
            </div>
        </div>

        <div class="main-workspace" id="main-workspace">
            <div class="track-grid" id="trackGrid">
                <!-- Las pistas y drop-zones se generan aqu√≠ -->
            </div>
        </div>

        <div class="sidebar sidebar-right">
            <h3>SAMPLES</h3>
            <div class="item-list-container" id="sample-list">
                 <div class="sample-item" draggable="true" data-type="sample" data-sound="kickSample"> <span class="item-icon">ü•Å</span> Kick Sample <div class="item-waveform"></div> </div>
            </div>
        </div>
    </div>

    <!-- No hay controles de transporte en esta versi√≥n, se asume que se a√±adir√≠an despu√©s -->

    <script>
        // --- LIBRER√çA DE SONIDOS: ¬°A√ëADE TUS ARCHIVOS MP3 AQU√ç! ---
        const soundLibrary = {
            'perc_80_shaker2': { url: 'audio/Ghosthack-Perc Loop_80_Shaker 2.mp3', bpm: 80 },
            'perc_90_shaker1': { url: 'audio/Ghosthack-Perc Loop_90_Shaker 1.mp3', bpm: 90 },
            'perc_110_fracture': { url: 'audio/Ghosthack-Perc Loop_110_Fracture.mp3', bpm: 110 },
            'perc_110_infinity': { url: 'audio/Ghosthack-Perc Loop_110_Infinity.mp3', bpm: 110 },
            'perc_120_latitude': { url: 'audio/Ghosthack-Perc Loop_120_Latitude.mp3', bpm: 120 },
            'perc_120_perc': { url: 'audio/Ghosthack-Perc Loop_120_Perc.mp3', bpm: 120 },
            'perc_120_propel': { url: 'audio/Ghosthack-Perc Loop_120_Propel.mp3', bpm: 120 },
            'perc_120_rims': { url: 'audio/Ghosthack-Perc Loop_120_Rims.mp3', bpm: 120 },
            'perc_120_shaker': { url: 'audio/Ghosthack-Perc Loop_120_Shaker.mp3', bpm: 120 },
            'perc_120_tops': { url: 'audio/Ghosthack-Perc Loop_120_Tops.mp3', bpm: 120 },
            'perc_120_torn': { url: 'audio/Ghosthack-Perc Loop_120_Torn.mp3', bpm: 120 },
            'perc_130_momentum': { url: 'audio/Ghosthack-Perc Loop_130_Momentum.mp3', bpm: 130 },
            'perc_130_shards': { url: 'audio/Ghosthack-Perc Loop_130_Shards.mp3', bpm: 130 },
            'perc_130_subdivision': { url: 'audio/Ghosthack-Perc Loop_130_Subdivision.mp3', bpm: 130 },
            'perc_140_perc': { url: 'audio/Ghosthack-Perc Loop_140_Perc.mp3', bpm: 140 },
            'perc_140_peril': { url: 'audio/Ghosthack-Perc Loop_140_Peril.mp3', bpm: 140 },
            'perc_150_tops': { url: 'audio/Ghosthack-Perc Loop_150_Tops.mp3', bpm: 150 },
            'perc_172_nebula': { url: 'audio/Ghosthack-Perc Loop_172_Nebula.mp3', bpm: 172 },
            'perc_172_spectrum': { url: 'audio/Ghosthack-Perc Loop_172_Spectrum.mp3', bpm: 172 },
            'perc_172_wavelength': { url: 'audio/Ghosthack-Perc Loop_172_Wavelength.mp3', bpm: 172 },
            // Samples
            'kickSample': { url: 'https://tonejs.github.io/audio/drum-samples/C_kick.mp3', type: 'sample' },
        };

        // --- ESTADO GLOBAL Y CONFIGURACI√ìN ---
        let currentSection = 'intro';
        const trackData = {}; // trackData['drums']['intro'] = { sound: 'kick120', name: ... }
        const TRACK_NAMES = ['drums', 'bass', 'pads', 'lead'];

        // --- INICIALIZACI√ìN ---
        window.onload = async () => {
            await Tone.start();
            console.log('Audio context listo.');

            populateLoopList();
            generateInitialGrid();
            setupDragAndDrop();
            setupSectionControls();
        };

        // --- GENERACI√ìN DE INTERFAZ DIN√ÅMICA ---
        function populateLoopList() {
            const loopList = document.getElementById('loop-list');
            const loopsByBPM = {};
            
            for (const key in soundLibrary) {
                const sound = soundLibrary[key];
                if (sound.type === 'sample') continue;
                if (!loopsByBPM[sound.bpm]) {
                    loopsByBPM[sound.bpm] = [];
                }
                loopsByBPM[sound.bpm].push({ key, ...sound });
            }

            for (const bpm in loopsByBPM) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'bpm-group';
                groupDiv.innerHTML = `<span class="bpm-label">${bpm} bpm</span>`;
                loopsByBPM[bpm].forEach(({key, name, url}) => {
                    const itemName = key.split('_').slice(2).join(' '); // ej. "perc 120 propel" -> "propel"
                    const itemEl = document.createElement('div');
                    itemEl.className = 'loop-item';
                    itemEl.draggable = true;
                    itemEl.dataset.sound = key;
                    itemEl.dataset.name = itemName.charAt(0).toUpperCase() + itemName.slice(1);
                    itemEl.innerHTML = `<span class="item-icon">üéµ</span> ${itemEl.dataset.name} <div class="item-waveform"></div>`;
                    groupDiv.appendChild(itemEl);
                });
                loopList.appendChild(groupDiv);
            }
        }

        function generateInitialGrid() {
            const trackGrid = document.getElementById('trackGrid');
            const sections = Array.from(document.querySelectorAll('.structure-btn')).map(btn => btn.dataset.section);

            TRACK_NAMES.forEach(trackName => {
                const trackLane = document.createElement('div');
                trackLane.className = 'track-lane';
                
                const label = document.createElement('div');
                label.className = `track-label ${trackName}`;
                label.textContent = trackName.toUpperCase();
                trackLane.appendChild(label);

                sections.forEach(sectionName => {
                    const zone = document.createElement('div');
                    zone.className = 'drop-zone';
                    zone.dataset.track = trackName;
                    zone.dataset.section = sectionName;
                    trackLane.appendChild(zone);
                });
                trackGrid.appendChild(trackLane);
            });
        }
        
        function addGridColumn(sectionKey) {
            document.querySelectorAll('.track-lane').forEach(lane => {
                const trackName = lane.querySelector('.track-label').textContent.toLowerCase();
                const zone = document.createElement('div');
                zone.className = 'drop-zone';
                zone.dataset.track = trackName;
                zone.dataset.section = sectionKey;
                lane.appendChild(zone);
            });
            setupDragAndDrop(); // Re-bind events to new drop zones
        }
        
        // --- L√ìGICA DE INTERACCI√ìN ---
        function setupDragAndDrop() {
            const draggables = document.querySelectorAll('[draggable="true"]');
            const dropZones = document.querySelectorAll('.drop-zone');

            draggables.forEach(item => {
                item.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('application/json', JSON.stringify({
                        sound: item.dataset.sound,
                        name: item.dataset.name
                    }));
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
                zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    const data = JSON.parse(e.dataTransfer.getData('application/json'));
                    addItemToTrack(zone.dataset.track, zone.dataset.section, data, zone);
                });
            });
        }

        function setupSectionControls() {
            const structureDiv = document.getElementById('songStructure');
            structureDiv.addEventListener('click', e => {
                const btn = e.target.closest('.structure-btn');
                if (!btn) return;
                document.querySelectorAll('.structure-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentSection = btn.dataset.section;
            });
            // La l√≥gica de repetici√≥n y reproducci√≥n se a√±adir√≠a aqu√≠.
            
            document.getElementById('addSectionBtn').addEventListener('click', addSection);
            document.getElementById('copySectionBtn').addEventListener('click', copyCurrentSection);
        }

        function addItemToTrack(track, section, data, zone) {
            zone.innerHTML = `<div class="dropped-item">${data.name}<button class="remove-btn" onclick="removeItem(this, '${track}', '${section}')">√ó</button></div>`;
            zone.classList.add('filled');
            if (!trackData[track]) trackData[track] = {};
            trackData[track][section] = { sound: data.sound, name: data.name };
            console.log(`A√±adido ${data.sound} a la pista ${track}, secci√≥n ${section}`);
        }
        
        function removeItem(btn, track, section) {
            const zone = btn.closest('.drop-zone');
            zone.classList.remove('filled');
            zone.innerHTML = '';
            if (trackData[track]) delete trackData[track][section];
        }

        function addSection() {
            const newSectionName = prompt('Nombre de la nueva secci√≥n:');
            if (!newSectionName) return;
            const sectionKey = newSectionName.toLowerCase().replace(/\s/g, '');

            const btn = document.createElement('button');
            btn.className = 'structure-btn';
            btn.dataset.section = sectionKey;
            btn.innerHTML = `${newSectionName}<span class="repeat-indicator">1</span>`;
            document.getElementById('songStructure').appendChild(btn);
            
            addGridColumn(sectionKey);
        }

        function copyCurrentSection() {
            const activeBtn = document.querySelector('.structure-btn.active');
            if (!activeBtn) {
                alert("Selecciona una secci√≥n para copiar.");
                return;
            }
            const originalSectionKey = activeBtn.dataset.section;
            const newName = prompt('Nombre para la copia:', `${originalSectionKey} 2`);
            if (!newName) return;
            
            const newSectionKey = newName.toLowerCase().replace(/\s/g, '');
            const btn = document.createElement('button');
            btn.className = 'structure-btn';
            btn.dataset.section = newSectionKey;
            btn.innerHTML = `${newName}<span class="repeat-indicator">${activeBtn.querySelector('.repeat-indicator').textContent}</span>`;
            document.getElementById('songStructure').appendChild(btn);

            addGridColumn(newSectionKey);
            
            // Copiar datos l√≥gicos y visuales
            TRACK_NAMES.forEach(track => {
                if (trackData[track] && trackData[track][originalSectionKey]) {
                    const data = trackData[track][originalSectionKey];
                    const newZone = document.querySelector(`.drop-zone[data-track="${track}"][data-section="${newSectionKey}"]`);
                    if (newZone) addItemToTrack(track, newSectionKey, data, newZone);
                }
            });
        }
    </script>
</body>
</html>

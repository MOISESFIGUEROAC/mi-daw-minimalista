<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAW v2.0 - Rediseño Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* CSS completo para la nueva interfaz */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        :root{--color-background:#1a1a1a;--color-grid:#333;--color-text:#ffffff;--color-magenta:#e60073;--color-purple:#7a3d99;--color-green:#00b359;--color-orange:#ff8c00;--pixels-per-beat:60px;}
        body{background-color:var(--color-background);color:var(--color-text);font-family:'Inter',sans-serif;margin:0;overflow:hidden;}
        #app-container{display:flex;flex-direction:column;height:100vh;}
        header{text-align:center;padding:1rem;font-size:1.5rem;letter-spacing:5px;border-bottom:1px solid var(--color-grid);}
        .daw-layout{display:grid;grid-template-columns:250px 1fr 250px;flex-grow:1;gap:1rem;padding:1rem;height:calc(100% - 80px);}
        aside{border-radius:12px;padding:1rem;display:flex;flex-direction:column;background-color:var(--color-magenta);}
        #samples-panel{background-color:var(--color-purple);}
        aside h2{margin:0 0 1rem 0;text-align:center;}
        .controls-row{display:flex;justify-content:space-between;align-items:center;background-color:rgba(0,0,0,0.5);padding:0.5rem 1rem;border-radius:20px;margin-bottom:1rem;}
        .bpm-display, .time-signature-display{display:flex;align-items:center;gap:0.5rem;}
        #bpm-input{width:50px;background:transparent;border:none;color:var(--color-text);font-size:1.2rem;font-weight:bold;text-align:right;}
        #time-signature{background:transparent;border:1px solid #777;color:white;border-radius:4px;}
        #bpm-input[type=number]{-moz-appearance:textfield;}
        .item-list{flex-grow:1;overflow-y:auto;padding-right:10px;}
        .draggable-item{background-color:rgba(255,255,255,0.2);padding:0.8rem;margin-bottom:0.5rem;border-radius:8px;cursor:grab;transition:background-color 0.2s ease;user-select:none;}
        .draggable-item:hover{background-color:rgba(255,255,255,0.4);}
        #main-workspace{display:flex;flex-direction:column;gap:1rem;background-color:#000;border-radius:12px;padding:1rem;overflow:hidden;}
        #timeline-container{position:relative;flex-grow:1;overflow-x:auto;overflow-y:hidden;}
        #arrangement-view{display:flex;flex-direction:row;min-height:100%;}
        .section{border:1px solid #555;border-radius:8px;padding:0.5rem;display:flex;flex-direction:column;gap:0.5rem;background:rgba(255,255,255,0.02);}
        .section-header{text-align:center;font-weight:bold;color:#aaa;padding-bottom:0.5rem;border-bottom:1px solid #444;}
        .track{background-color:rgba(255,255,255,0.05);border-radius:8px;height:80px;position:relative;background-image:linear-gradient(90deg,var(--color-grid) 1px,transparent 1px);background-size:var(--pixels-per-beat) 100%;}
        .track.drag-over{border:2px dashed var(--color-green);}
        .clip{position:absolute;height:60px;top:10px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;padding:0 1rem;box-sizing:border-box;color:white;font-weight:bold;cursor:move;z-index:10;}
        .clip.loop-clip{background-color:var(--color-green);}
        .clip.sample-clip{background-color:var(--color-orange);}
        .clip-repeat-input{width:40px;background:rgba(0,0,0,0.5);color:white;border:1px solid #fff;border-radius:4px;text-align:center;font-weight:bold;}
        #playhead{position:absolute;top:0;left:0;width:2px;height:100%;background-color:red;z-index:20;pointer-events:none;}
        #transport-controls{display:flex;justify-content:center;align-items:center;gap:1.5rem;padding:0.5rem;background:#222;border-radius:8px;}
        #play-button, #add-section-btn, #click-toggle{border:none;color:white;height:50px;border-radius:50%;font-size:1.5rem;cursor:pointer;transition:background-color 0.2s;}
        #play-button{width:50px;background-color:var(--color-magenta);}
        #add-section-btn{width:50px;background-color:#555;}
        #click-toggle{width:50px;background-color:#555;font-size:1rem;}
        #click-toggle.active{background-color:var(--color-orange);}
        #time-display{font-size:1.2rem;font-variant-numeric:tabular-nums;}
        #start-modal{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:1000;}
        #start-button{padding:1rem 2rem;font-size:1.5rem;background-color:var(--color-magenta);color:white;border:none;border-radius:8px;cursor:pointer;}
    </style>
</head>
<body>

    <div id="app-container">
        <header><h1>DAW v2.0</h1></header>

        <main class="daw-layout">
            <aside id="loops-panel">
                <h2>LOOPS</h2>
                <div class="controls-row">
                    <div class="bpm-display"><input type="number" id="bpm-input" value="120">bpm</div>
                    <div class="time-signature-display">
                        <select id="time-signature"><option value="4/4" selected>4/4</option><option value="3/4">3/4</option><option value="6/8">6/8</option></select>
                    </div>
                </div>
                <div class="item-list" id="loop-list">
                    <div class="draggable-item loop-item" draggable="true" data-src="audio/Ghosthack-Perc Loop_120_Perc.mp3" data-name="Perc (120bpm)">Perc (120bpm)</div>
                    <div class="draggable-item loop-item" draggable="true" data-src="audio/Ghosthack-Perc Loop_120_Tops.mp3" data-name="Tops (120bpm)">Tops (120bpm)</div>
                </div>
            </aside>

            <section id="main-workspace">
                <div id="timeline-container">
                    <div id="playhead"></div>
                    <div id="arrangement-view">
                        <!-- Las secciones se añadirán aquí dinámicamente -->
                    </div>
                </div>
                <div id="transport-controls">
                    <button id="add-section-btn" title="Añadir Sección">+</button>
                    <button id="click-toggle" title="Activar/Desactivar Metrónomo">Click</button>
                    <button id="play-button" title="Reproducir/Detener">▶</button>
                    <div id="time-display">0:0:0</div>
                </div>
            </section>

            <aside id="samples-panel">
                <h2>SAMPLES</h2>
                <div class="item-list" id="sample-list">
                     <div class="draggable-item sample-item" draggable="true" data-src="https://tonejs.github.io/audio/drum-samples/C_kick.mp3" data-name="Kick">Kick</div>
                </div>
            </aside>
        </main>
    </div>
    
    <div id="start-modal"><button id="start-button">Iniciar DAW</button></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTOS DEL DOM ---
        const startModal = document.getElementById('start-modal');
        const startButton = document.getElementById('start-button');
        const playButton = document.getElementById('play-button');
        const bpmInput = document.getElementById('bpm-input');
        const timeSignatureSelect = document.getElementById('time-signature');
        const loopList = document.getElementById('loop-list');
        const timeDisplay = document.getElementById('time-display');
        const clickToggleButton = document.getElementById('click-toggle');
        const arrangementView = document.getElementById('arrangement-view');
        const addSectionBtn = document.getElementById('add-section-btn');
        const playhead = document.getElementById('playhead');

        // --- CONFIGURACIÓN Y ESTADO GLOBAL ---
        let isPlaying = false;
        let isClickEnabled = false;
        const audioPlayers = {};
        let draggedElement = null;
        const pixelsPerBeat = 60; // Aumentado para más espacio
        let sectionCounter = 0;
        let sections = {}; // { sectionId: { element, startBeats, totalBeats, ... } }

        // --- INICIALIZACIÓN DE AUDIO (SYNTHS Y PLAYERS) ---
        const previewPlayer = new Tone.Player().toDestination();
        const highClick = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 10, oscillator: { type: 'square' }, envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 0.2 } }).toDestination();
        const lowClick = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 4, oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.3, sustain: 0.01, release: 0.2 } }).toDestination();

        startButton.addEventListener('click', async () => {
            await Tone.start();
            initializeDAW();
            startModal.style.display = 'none';
        });

        function initializeDAW() {
            Tone.Transport.bpm.value = parseInt(bpmInput.value);
            updateTimeSignature();
            Tone.Transport.scheduleRepeat(onBeat, '8n');
            requestAnimationFrame(updateUI); // Bucle principal de actualización de UI
            
            // Crear secciones iniciales
            addSection('Intro');
            addSection('Verso');
            addSection('Coro');
            addSection('Outro');
        }
        
        // --- LÓGICA DEL ARREGLADOR DE SECCIONES ---
        function addSection(type = 'Sección') {
            sectionCounter++;
            const sectionId = `section-${sectionCounter}`;
            const beatsPerSection = 16; // 4 compases de 4/4 por defecto

            const sectionEl = document.createElement('div');
            sectionEl.className = 'section';
            sectionEl.id = sectionId;
            sectionEl.style.width = `${beatsPerSection * pixelsPerBeat}px`;
            sectionEl.innerHTML = `
                <div class="section-header">${type}</div>
                <div class="track" data-track-id="1"></div>
                <div class="track" data-track-id="2"></div>
                <div class="track" data-track-id="3"></div>
            `;
            arrangementView.appendChild(sectionEl);
            
            // Almacenar información de la sección
            sections[sectionId] = {
                element: sectionEl,
                totalBeats: beatsPerSection,
                startBeats: 0 // Se calculará después
            };
            updateSectionStartTimes();
        }

        function updateSectionStartTimes() {
            let currentBeats = 0;
            document.querySelectorAll('.section').forEach(sectionEl => {
                const sectionId = sectionEl.id;
                sections[sectionId].startBeats = currentBeats;
                currentBeats += sections[sectionId].totalBeats;
            });
        }
        addSectionBtn.addEventListener('click', () => addSection());

        // --- CONTROLES DE TRANSPORTE Y METRÓNOMO ---
        playButton.addEventListener('click', () => {
            isPlaying = !isPlaying;
            playButton.textContent = isPlaying ? '■' : '▶';
            if (isPlaying) Tone.Transport.start(); else Tone.Transport.stop();
        });

        clickToggleButton.addEventListener('click', () => {
            isClickEnabled = !isClickEnabled;
            clickToggleButton.classList.toggle('active', isClickEnabled);
        });

        bpmInput.addEventListener('change', e => { Tone.Transport.bpm.value = parseInt(e.target.value); });
        timeSignatureSelect.addEventListener('change', updateTimeSignature);
        function updateTimeSignature() {
            const [num] = timeSignatureSelect.value.split('/').map(Number);
            Tone.Transport.timeSignature = num;
        }

        function onBeat(time) {
            const [bar, beat, subdivision] = Tone.Transport.position.split(':').map(Number);
            if (isClickEnabled && subdivision === 0) {
                if (beat === 0) highClick.triggerAttackRelease('C2', '8n', time);
                else lowClick.triggerAttackRelease('C2', '8n', time);
            }
        }
        
        // --- BUCLE PRINCIPAL DE ACTUALIZACIÓN DE UI ---
        function updateUI() {
            if (isPlaying) {
                timeDisplay.textContent = Tone.Transport.position.split('.')[0];
                const totalBeats = Tone.Transport.ticks / Tone.Transport.PPQ;
                playhead.style.transform = `translateX(${totalBeats * pixelsPerBeat}px)`;
            }
            requestAnimationFrame(updateUI);
        }

        // --- LÓGICA DE VISTA PREVIA ---
        loopList.addEventListener('click', e => {
            if (e.target.classList.contains('draggable-item')) {
                if (previewPlayer.state === 'started') previewPlayer.stop();
                previewPlayer.load(e.target.dataset.src).then(() => previewPlayer.start());
            }
        });

        // --- LÓGICA DE DRAG & DROP ---
        document.body.addEventListener('dragstart', e => { draggedElement = e.target; });
        arrangementView.addEventListener('dragover', e => {
            e.preventDefault();
            const targetTrack = e.target.closest('.track');
            if (targetTrack) {
                document.querySelectorAll('.track.drag-over').forEach(t => t.classList.remove('drag-over'));
                targetTrack.classList.add('drag-over');
            }
        });
        
        arrangementView.addEventListener('drop', e => {
            e.preventDefault();
            const targetTrack = e.target.closest('.track');
            if (!draggedElement || !targetTrack) return;
            
            targetTrack.classList.remove('drag-over');
            const targetSectionEl = targetTrack.closest('.section');
            const sectionId = targetSectionEl.id;
            const sectionInfo = sections[sectionId];
            
            const trackRect = targetTrack.getBoundingClientRect();
            const sectionRect = targetSectionEl.getBoundingClientRect();
            const dropX = e.clientX - trackRect.left;
            
            const beatInTrack = Math.floor(dropX / pixelsPerBeat);
            const snappedX = beatInTrack * pixelsPerBeat;
            
            const totalStartBeats = sectionInfo.startBeats + beatInTrack;
            const bar = Math.floor(totalStartBeats / Tone.Transport.timeSignature);
            const beat = totalStartBeats % Tone.Transport.timeSignature;
            const startTime = `${bar}:${beat}:0`;

            if (draggedElement.classList.contains('clip')) {
                // Mover clip es más complejo en esta arquitectura, por ahora se crea uno nuevo
                console.warn("Mover clips no está implementado en esta versión.");
            } else if (draggedElement.classList.contains('draggable-item')) {
                createClip(draggedElement, targetTrack, snappedX, startTime);
            }
        });

        // --- FUNCIONES DE MANEJO DE CLIPS ---
        function createClip(sourceItem, targetTrack, positionX, startTime) {
            const clipId = `clip-${Date.now()}`;
            const clipElement = document.createElement('div');
            clipElement.id = clipId;
            clipElement.className = 'clip';
            clipElement.draggable = true;
            clipElement.style.left = `${positionX}px`;
            clipElement.textContent = sourceItem.dataset.name;
            
            const isLoop = sourceItem.classList.contains('loop-item');
            clipElement.classList.add(isLoop ? 'loop-clip' : 'sample-clip');
            
            targetTrack.appendChild(clipElement);

            const player = new Tone.Player(sourceItem.dataset.src, () => {
                const durationBeats = player.buffer.duration / Tone.Time('4n').toSeconds();
                clipElement.style.width = `${durationBeats * pixelsPerBeat}px`;
                scheduleAudio(clipId, player, startTime, isLoop);
            }).toDestination();
            
            audioPlayers[clipId] = { player, element: clipElement, schedule: null };
            
            clipElement.addEventListener('dblclick', () => deleteClip(clipId));
        }
        
        function deleteClip(clipId) {
            const clipData = audioPlayers[clipId];
            if (!clipData) return;
            if (clipData.schedule) clipData.schedule.dispose();
            clipData.player.dispose();
            clipData.element.remove();
            delete audioPlayers[clipId];
        }

        function scheduleAudio(clipId, player, startTime, isLoop) {
             const loop = new Tone.Loop(time => {
                if (player.loaded) player.start(time);
            }, player.buffer.duration);
            
            if (!isLoop) loop.iterations = 1;
            loop.start(startTime);
            audioPlayers[clipId].schedule = loop;
        }
    });
    </script>
</body>
</html>
